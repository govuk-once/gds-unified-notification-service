// This script is to be executed via npm run development:sandbox:setup
// Generates environment ID based on email signing the commits (git config -- set user.email)
// Saves generated config into teraform/notifications/terraform.tfvars
// If AWS environment variables are present 
// - prompts the creation if tfstate bucket does not exist
// - prompts terraform initiation
import { CreateBucketCommand, ListBucketsCommand, S3Client } from "@aws-sdk/client-s3";
import { GetCallerIdentityCommand, STSClient } from "@aws-sdk/client-sts";
import { $, file } from 'bun';
import { createHash } from 'node:crypto';

// Helper FN to simplify promise handling, and avoid nested try catches
const unwrap = async <Result>(promise: Promise<Result>): Promise<[Result, undefined] | [undefined, Error]> => {
  try{
    return [await promise, undefined];
  } catch (error) {
    return [undefined, error];
  }
}

(async function () {
  const tfvars = `./terraform/notifications/terraform.tfvars`;
  // Generate unique values based on github user email
  const email = (await $`git config --get user.email`).text().trim();
  const hash = createHash('md5').update(email).digest('hex').substring(4, 8);
  const id = `${email.split('.').shift()}-${hash}`;
  const bucket = `govuk-once-nofications-dev-${id}-tfstate`;

  // Save to file
  file(tfvars).write(`# Auto-generated by ${import.meta.file}
# For developer: ${email}

bucket          = "${bucket}"
key             = "state.tfstate"
region          = "eu-west-2"
id             = "${id}"`);

  // Ensure AWS env vars are available
  if(
    process.env.AWS_ACCESS_KEY_ID == undefined ||
    process.env.AWS_SECRET_ACCESS_KEY == undefined ||
    process.env.AWS_REGION == undefined
  ) {
    return console.log(`No AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY present in env vars, please use 'eval $(gds-cli aws {accountName} -e)'`);
  }

  // Fetch current account id
  const [stsClient, s3Client] = [new STSClient(), new S3Client()];
  const [identityResult, identityError] = await unwrap((stsClient).send(new GetCallerIdentityCommand()));
  if(identityResult == undefined) {
    return console.error(`Failed to fetch account ID :${identityError.message}`);
  }
  // Only log last 4 digits of account id
  const accountIdHashed = identityResult.Account?.substring(8).padStart(identityResult.Account.length, "*");

  // Fetch buckets
  const [listBucketsResult, listBucketsError] = await unwrap((s3Client).send(new ListBucketsCommand()))
  if(listBucketsResult == undefined) {
      return console.error(`Failed to fetch buckets: ${listBucketsError.message}`);
  }

  // Prompt bucket creation if the state storage doesnt exist
  if((listBucketsResult.Buckets?.map(bucket => bucket.Name)?.includes(bucket)) == false) {
    // Prompt to create a bucket outlining AWS account used
    if(confirm(`Would you like to create ${bucket} in ${accountIdHashed}`)) {
      const [createBucketResult, createBucketError] = await unwrap(
        s3Client.send(new CreateBucketCommand({Bucket: bucket, ACL: "private"}))
      );
      if(createBucketResult == undefined) {
        return console.error(`Failed creation of a ${bucket}: ${createBucketError.message}`);
      }
      console.log(`Created ${bucket} in ${createBucketResult.Location} ARN: ${createBucketResult.BucketArn}`);
    }
  } else {
    console.log(`Developer tfstate bucket ${bucket} already exists in current ${accountIdHashed}`)
  } 

  // Prompt to perform tf init
  if(confirm(`Would you like to initialize terraform?`)) {
    (await $.cwd('terraform/notifications')`terraform init \
      -backend-config "bucket=${bucket}" \
      -backend-config "key=state.tfstate" \
      -backend-config "region=eu-west-2"`).text();
  }
})();
